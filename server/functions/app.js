!function(e){var t={};function r(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(a,s,function(t){return e[t]}.bind(null,s));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=9)}([function(e,t){e.exports=require("express")},function(e,t,r){const a=r(15);var s;"local"===process.env.DB?(s=a.createConnection({host:process.env.DB_HOST,database:process.env.DB_NAME,user:process.env.DB_USER,password:process.env.DB_PASSWORD})).connect(e=>{if(e)return console.log("connection error"),void console.log(e)}):(s=a.createConnection({host:process.env.AWS_DB_HOST,database:process.env.AWS_DB_NAME,user:process.env.AWS_DB_USER,password:process.env.AWS_DB_PASSWORD})).connect(e=>{if(e)return console.log("connection error"),void console.log(e)}),e.exports=s},function(e,t){e.exports=(e,t,r)=>{r.error?t(r):e.json(r)}},function(e,t){e.exports=require("joi")},function(e,t,r){const a=r(1);class s{static getSettings(e){a.query("SELECT * FROM settings",(t,r)=>{if(t)e({type:"DatabaseError",error:t});else{const t=JSON.stringify(r),a=JSON.parse(t);e(a)}})}static updateSettings(e,t){a.query("UPDATE settings SET ? WHERE id = 0",e,(e,r,s)=>{e?t({type:"DatabaseError",error:e}):a.query("SELECT * FROM `settings`",(e,r)=>{t(r[0])})})}static postUnpublishEntity(e,t,r){s.getSettings(a=>{const{highlighted_travels_fr:i,highlighted_travels_it:n,highlighted_articles_fr:o,highlighted_articles_it:l,slider_fr:c,slider_it:d,...p}=a[0];let u={};"travel"===e&&Object.keys(a[0]).forEach(e=>{(e.startsWith("highlighted_travels_")||e.startsWith("slider_"))&&a[0][e]&&a[0][e].includes(Number(t))&&(u[e]=a[0][e].filter(e=>e!==Number(t)))}),"article"===e&&Object.keys(a[0]).forEach(e=>{e.startsWith("highlighted_articles_")&&a[0][e]&&a[0][e].includes(Number(t))&&(u[e]=a[0][e].filter(e=>e!==Number(t)))});const b={...a[0],...u};Object.keys(b).forEach(e=>{"object"==typeof b[e]&&(b[e]=JSON.stringify(b[e]))}),console.log(b),s.updateSettings(b,e=>{r(e)})})}}e.exports=s},function(e,t,r){const a=r(1),s=r(16),i=r(21),n=r(22);class o{static getUsers(e){a.query("SELECT * FROM users",(t,r)=>{if(t)e({type:"DatabaseError",error:t,message:"Cannot get data from database"});else{var a=JSON.stringify(r),s=JSON.parse(a);e(s)}})}static getUserById(e,t){a.query("SELECT * FROM `users` WHERE `user_id` = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r[0]),s=null==a?{type:"DatabaseError",error:e,message:"This user is not registered in database"}:JSON.parse(a);t(s)}})}static getUserByEmail(e,t){a.query("SELECT * FROM `users` WHERE `user_email` = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r[0]),s=null==a?{type:"DatabaseError",error:e,message:"This user is not registered in database"}:JSON.parse(a);t(s)}})}static updateUser(e,t,r){a.query("UPDATE `users` SET ? WHERE `user_id` = ?",[e,t],(e,s)=>{e?r({type:"DatabaseError",error:e}):a.query("SELECT * FROM `users` WHERE `user_id` = ?",[t],(e,t)=>{if(e)r({type:"DatabaseError",error:e});else{var a=JSON.stringify(t[0]),s=null==a?{type:"DatabaseError",error:e,message:"This user is not registered in database"}:JSON.parse(a);r(s)}})})}static deleteUser(e,t){a.query("DELETE FROM `users` WHERE `user_id` = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}static createNewUser(e,t){this.getUsers(r=>{r.filter(t=>t.user_email==e.email).length?t({type:"DatabaseError",error:"This user is already registered"}):o.postUser(e,e=>{t(e)})})}static signup(e,t,r){this.getUsers(a=>{let s=a.filter(t=>t.user_email==e);s&&s.length?(s=s[0],n.hash(t,12,(e,t)=>{e?r({type:"DatabaseError",status:500,error:"pwd_hash_pbm",message:"There was an error during the creation of the password"}):o.saveUserPwd(s,t,e=>{r(e)})})):r({type:"AuthorizationError",status:403,error:"no_such_user",message:"No such user in database, you should make a request to the admin first"})})}static signin(e,t,r){this.getUsers(a=>{let s=a.filter(t=>t.user_email==e);var o;s.length&&null!=s?(s=s[0],n.compare(t,s.user_password,(e,t)=>{if(e&&(o={status:401,failed:"Unauthorized Access"}),t){const e=i.sign({email:s.user_email,role:s.user_role},process.env.JWT_SECRET,{expiresIn:"2d"});o={status:200,success:"Success",token:e}}t||(o={status:401,error:"Your password is wrong, try again"}),r(o)})):r(o={status:500,error:"No such user in database"})})}static resetPasswordRequest(e,t,r){this.getUserByEmail(e,a=>{this.updateUser({...a,user_pwd_token:t},a.user_id,a=>{const i={type:"resetPasswordRequest",email:e,pwd_token:t};this.getSuperAdmin(e=>{s.sendMail(e.user_email,i,e=>{r(e)})})})})}static postUser(e,t){const r={user_email:e.email,user_role:e.role,user_password:"",user_username:e.email,user_pwd_token:e.pwd_token};console.log(e),a.query("INSERT INTO `users` SET ?",r,(e,r)=>{t(e?{type:"DatabaseError",error:e}:r)})}static saveUserPwd(e,t,r){let s={...e,user_password:t,user_pwd_token:null};a.query("UPDATE `users` SET ? WHERE `user_email` = ?",[s,e.user_email],(e,t)=>{r(e?{type:"DatabaseError",error:e}:t)})}static getSuperAdmin(e){a.query('SELECT * from `users` WHERE `user_role` = "superadmin"',(t,r)=>{if(t)e({type:"DatabaseError",error:t});else{var a=JSON.stringify(r[0]),s=JSON.parse(a);e(s)}})}static userRequest(e,t,r,a,i){const n={type:e,requestedRole:r,email:t,pwd_token:a};"confirm"==e&&this.createNewUser({email:t,role:r,pwd_token:a},e=>{i(e)}),console.log(n),this.getSuperAdmin(e=>{s.sendMail(e.user_email,n,e=>{i(e)})})}static verifyToken(e,t){i.verify(e,process.env.JWT_SECRET,(e,r)=>{var a=r;e&&(a=e),t(a)})}}e.exports=o},function(e,t,r){const a=r(3),s=r(26),i=r(27),n=r(28),o=r(29);validate=(e,t,r)=>{let l;switch(t){case"user":l=s;break;case"article":l=i;break;case"travel":l=n;break;case"asset":l=o}const c={body:l[r]};return new Promise((t,r)=>{a.validate(e,c.body,(e,a)=>{e?r(e):t(a)})})},e.exports=validate},function(e,t){validateRole=(e,t)=>(Array.isArray(t)||(t=[t]),new Promise((r,a)=>{const s=Buffer.from(e.split(".")[1],"base64").toString("binary"),i=JSON.parse(s).role;t.includes(i)?r():a({type:"AuthorizationError",error:`You need to have ${i} role to do this`})})),e.exports=validateRole},function(e,t){e.exports=require("aws-sdk")},function(e,t,r){"use strict";const a=r(0)(),s=(process.env.PORT,r(10)),i=r(11),n=r(12),o=r(13),l=r(14),c=r(23),d=r(24),p=r(30),u=r(32),b=r(33),g=r(40),f=r(42),y=r(44);a.get("env"),"development"===a.get("env")&&a.use(n),a.use(o.json()),a.use(o.urlencoded({extended:!0})),a.use(l);const _="/.netlify/functions/app";a.get("/",(e,t)=>{t.json({message:"Hello World!"})}),a.use(_+"/api/articles",d),a.use(_+"/api/travels",p),a.use(_+"/api/users",u),a.use(_+"/api/assets",b),a.use(_+"/api/settings",y),a.use(_+"/api/anecdotes",g),a.use(_+"/api/categories",f),a.use(c),a.get("*",(e,t,r)=>{if(-1===e.url.indexOf(".")&&-1==e.url.indexOf("json")||e.url.match(/\?([^&=]+)=([^&=]+)(?:&([^&=]+)=([^&=]+))*$/gm)){console.log("SPA: %s",e.url);const r="../admin/";t.sendFile(s.join(__dirname,r,"index.html"))}else console.log("Static: %s",e.url),t.sendFile(s.join(__dirname,"../",e.url))}),e.exports=a,e.exports.handler=i(a)},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("serverless-http")},function(e,t){e.exports=function(e,t,r){t.headersSent||(t.setHeader("Access-Control-Allow-Methods","POST, PUT, OPTIONS, DELETE, GET"),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization, Content-Length, X-Requested-With, Accept, x-access-token"),r())}},function(e,t){e.exports=require("body-parser")},function(e,t,r){const a=r(5);e.exports=function(e,t,r){const s=e.headers["x-access-token"];let i=!0;if(("OPTIONS"==e.method||"GET"==e.method&&!e.url.includes("users")||"GET"==e.method&&e.originalUrl.includes("users/email")||"POST"==e.method&&e.originalUrl.includes("users/request")&&"request"==e.body.type||"POST"==e.method||"OPTIONS"==e.method&&e.originalUrl.includes("users/signin")||"POST"==e.method&&e.originalUrl.includes("users/signup"))&&(i=!1),i&&!s)return t.status(403).json({error:"Not authorized",message:"You should be logged to make this request"});i&&s?a.verifyToken(s,e=>"JsonWebTokenError"==e.name?t.status(403).json({error:e.message,message:"You don't provide right user infos"}):"TokenExpiredError"==e.name?t.status(403).json({error:e.message,message:"You have to login again"}):void r()):r()}},function(e,t){e.exports=require("mysql2")},function(e,t,r){const a=r(17),{google:s}=r(18),i=s.auth.OAuth2,n=r(19);e.exports=class{static setupMail(e,t){const r=new i(process.env.G_CLIENT_ID,process.env.G_CLIENT_SECRET,process.env.G_REDIRECT_URL);r.setCredentials({refresh_token:process.env.G_REFRESH_TOKEN}),r.getAccessToken((r,s)=>{if(r)throw r;const i=a.createTransport({service:"gmail",auth:{type:"OAuth2",user:e,clientId:process.env.G_CLIENT_ID,clientSecret:process.env.G_CLIENT_SECRET,refreshToken:process.env.G_REFRESH_TOKEN,accessToken:s}});t(i)})}static sendMail(e,t,r){let a=t.email,s=e;"request"!==t.type&&(s=t.email,a=e);new Promise((t,r)=>{this.setupMail(e,e=>{e?t(e):r("There was a problem during the creation of the mail")})}).then(e=>{const i=n.getMailTemplate(t),o=n.getMailOptions(a,s,t.type,i);console.log("SMTP",a,s),e.sendMail(o,(t,a)=>{if(t)throw t;e.close(),r(a)})}).catch(e=>{r(e)})}}},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("googleapis")},function(e,t,r){const a=process.env.BASE_PATH,s=r(20);e.exports=class{static getMailOptions(e,t,r,a){let s={subject:"",text:""};switch(r){case"request":s.subject="New request user for Travel blog",s.text="You have a request for a new user";break;case"confirm":s.subject="Your request has been confirmed",s.text="Your request has been confirmed by the team !";break;case"refuse":s.subject="Sorry but your request has been rejected",s.text="Your request for travel blog has been rejected";break;case"resetPasswordRequest":s.subject="Password change request",s.text="Carte de Voyages password change request";break;case"resetPasswordChange":s.subject="Password changed",s.text="Carte de Voyages password changed";break;default:s.subject="Something happens on travel blog",s.text="Do you want to see what happens ?"}return{from:{name:process.env.SITENAME,address:e},to:t,subject:s.subject,text:s.text,html:a}}static getMailTemplate(e){switch(e.type){case"request":return this.getSendRequestTemplate(e.email,e.requestedRole);case"confirm":return this.getConfirmRequestTemplate(e.email,e.requestedRole,e.pwd_token);case"refuse":return this.getRefuseRequestTemplate(e.email,e.requestedRole);case"resetPasswordRequest":return this.getResetPasswordRequestTemplate(e.email,e.pwd_token);case"resetPasswordChanged":return this.getResetPasswordChangedTemplate(e.email);default:return""}}static getSendRequestTemplate(e,t){return`<!doctype html>\n    <html>\n      ${s.head}\n      <body class="" style="background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;">\n        <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;">\n          <tr>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n            <td class="container" style="font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;">\n              <div class="content" style="box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;">\n\n                \x3c!-- START CENTERED WHITE CONTAINER --\x3e\n                <span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">Une personne demande à acceder au blog</span>\n                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;">\n\n                  \x3c!-- START MAIN CONTENT AREA --\x3e\n                  <tr>\n                    <td class="wrapper" style="font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px;">\n                      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                        <tr>\n                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Salut,</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Une personne demande à acceder au blog : ${e}</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Rôle demandé : ${t}</p>\n\n                            <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; box-sizing: border-box;">\n                              <tbody>\n                                <tr>\n                                  <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;">\n                                    <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">\n                                      <tbody>\n                                        <tr>\n                                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; background-color: #3498db; border-radius: 5px; text-align: center;"> <a href="${a}#!/userrequest/${e}/${t}" target="_blank" style="display: inline-block; color: #ffffff; background-color: #3498db; border: solid 1px #3498db; border-radius: 5px; box-sizing: border-box; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-transform: capitalize; border-color: #3498db;">Vérifier</a> </td>\n                                        </tr>\n\n                                      </tbody>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </tbody>\n                            </table>\n\n                          </td>\n                        </tr>\n                      </table>\n                    </td>\n                  </tr>\n\n                \x3c!-- END MAIN CONTENT AREA --\x3e\n                </table>\n\n                \x3c!-- START FOOTER --\x3e\n                ${s.footer}\n                \x3c!-- END FOOTER --\x3e\n\n              \x3c!-- END CENTERED WHITE CONTAINER --\x3e\n              </div>\n            </td>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n          </tr>\n        </table>\n      </body>\n    </html>`}static getConfirmRequestTemplate(e,t,r){return`<!doctype html>\n    <html>\n      ${s.head}\n      <body class="" style="background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;">\n        <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;">\n          <tr>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n            <td class="container" style="font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;">\n              <div class="content" style="box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;">\n\n                \x3c!-- START CENTERED WHITE CONTAINER --\x3e\n                <span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">Une personne demande à acceder au blog</span>\n                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;">\n\n                  \x3c!-- START MAIN CONTENT AREA --\x3e\n                  <tr>\n                    <td class="wrapper" style="font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px;">\n                      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                        <tr>\n                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Salut,</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Votre demande pour accèder au blog a été confirmée pour cet email : ${e}</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Votre rôle : ${t}</p>\n\n                            <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; box-sizing: border-box;">\n                              <tbody>\n                                <tr>\n                                  <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;">\n                                    <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">\n                                      <tbody>\n                                        <tr>\n                                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; background-color: #3498db; border-radius: 5px; text-align: center;"> <a href="${a}/?email=${e}&pwd_token=${r}" target="_blank" style="display: inline-block; color: #ffffff; background-color: #3498db; border: solid 1px #3498db; border-radius: 5px; box-sizing: border-box; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-transform: capitalize; border-color: #3498db;">Vérifier</a> </td>\n                                        </tr>\n\n                                      </tbody>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </tbody>\n                            </table>\n\n                          </td>\n                        </tr>\n                      </table>\n                    </td>\n                  </tr>\n\n                \x3c!-- END MAIN CONTENT AREA --\x3e\n                </table>\n\n                \x3c!-- START FOOTER --\x3e\n                ${s.footer}\n                \x3c!-- END FOOTER --\x3e\n\n              \x3c!-- END CENTERED WHITE CONTAINER --\x3e\n              </div>\n            </td>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n          </tr>\n        </table>\n      </body>\n    </html>`}static getRefuseRequestTemplate(e,t){return`<!doctype html>\n    <html>\n      ${s.head}\n      <body class="" style="background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;">\n        <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;">\n          <tr>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n            <td class="container" style="font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;">\n              <div class="content" style="box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;">\n\n                \x3c!-- START CENTERED WHITE CONTAINER --\x3e\n                <span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">Une personne demande à acceder au blog</span>\n                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;">\n\n                  \x3c!-- START MAIN CONTENT AREA --\x3e\n                  <tr>\n                    <td class="wrapper" style="font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px;">\n                      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                        <tr>\n                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Salut,</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Votre demande pour accèder au blog a été refusée pour cet email : ${e}</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Rôle demandé : ${t}</p>\n\n                            <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; box-sizing: border-box;">\n                              <tbody>\n                                <tr>\n                                  <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;">\n                                    <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">\n                                      <tbody>\n                                        <tr>\n                                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; background-color: #3498db; border-radius: 5px; text-align: center;"> <a href="${a}/#!" target="_blank" style="display: inline-block; color: #ffffff; background-color: #3498db; border: solid 1px #3498db; border-radius: 5px; box-sizing: border-box; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-transform: capitalize; border-color: #3498db;">Tant pis</a> </td>\n                                        </tr>\n\n                                      </tbody>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </tbody>\n                            </table>\n\n                          </td>\n                        </tr>\n                      </table>\n                    </td>\n                  </tr>\n\n                \x3c!-- END MAIN CONTENT AREA --\x3e\n                </table>\n\n                \x3c!-- START FOOTER --\x3e\n                ${s.footer}\n                \x3c!-- END FOOTER --\x3e\n\n              \x3c!-- END CENTERED WHITE CONTAINER --\x3e\n              </div>\n            </td>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n          </tr>\n        </table>\n      </body>\n    </html>`}static getResetPasswordRequestTemplate(e,t){return`<!doctype html>\n    <html>\n      ${s.head}\n      <body class="" style="background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;">\n        <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;">\n          <tr>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n            <td class="container" style="font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;">\n              <div class="content" style="box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;">\n\n                \x3c!-- START CENTERED WHITE CONTAINER --\x3e\n                <span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">Une personne demande à acceder au blog</span>\n                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;">\n\n                  \x3c!-- START MAIN CONTENT AREA --\x3e\n                  <tr>\n                    <td class="wrapper" style="font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px;">\n                      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                        <tr>\n                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Salut,</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Vous avez demandé à modifier votre mot de passe pour cet email : ${e}</p>\n\n                            <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; box-sizing: border-box;">\n                              <tbody>\n                                <tr>\n                                  <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;">\n                                    <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">\n                                      <tbody>\n                                        <tr>\n                                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; background-color: #3498db; border-radius: 5px; text-align: center;"> <a href="${a}login?email=${e}&pwd_token=${t}" target="_blank" style="display: inline-block; color: #ffffff; background-color: #3498db; border: solid 1px #3498db; border-radius: 5px; box-sizing: border-box; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-transform: capitalize; border-color: #3498db;">Modifier le mot de passe</a> </td>\n                                        </tr>\n\n                                      </tbody>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </tbody>\n                            </table>\n\n                          </td>\n                        </tr>\n                      </table>\n                    </td>\n                  </tr>\n\n                \x3c!-- END MAIN CONTENT AREA --\x3e\n                </table>\n\n                \x3c!-- START FOOTER --\x3e\n                ${s.footer}\n                \x3c!-- END FOOTER --\x3e\n\n              \x3c!-- END CENTERED WHITE CONTAINER --\x3e\n              </div>\n            </td>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n          </tr>\n        </table>\n      </body>\n    </html>`}static getResetPasswordChangeTemplate(e){return`<!doctype html>\n    <html>\n      ${s.head}\n      <body class="" style="background-color: #f6f6f6; font-family: sans-serif; -webkit-font-smoothing: antialiased; font-size: 14px; line-height: 1.4; margin: 0; padding: 0; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%;">\n        <table border="0" cellpadding="0" cellspacing="0" class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background-color: #f6f6f6;">\n          <tr>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n            <td class="container" style="font-family: sans-serif; font-size: 14px; vertical-align: top; display: block; Margin: 0 auto; max-width: 580px; padding: 10px; width: 580px;">\n              <div class="content" style="box-sizing: border-box; display: block; Margin: 0 auto; max-width: 580px; padding: 10px;">\n\n                \x3c!-- START CENTERED WHITE CONTAINER --\x3e\n                <span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">Une personne demande à acceder au blog</span>\n                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #ffffff; border-radius: 3px;">\n\n                  \x3c!-- START MAIN CONTENT AREA --\x3e\n                  <tr>\n                    <td class="wrapper" style="font-family: sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 20px;">\n                      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                        <tr>\n                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Salut,</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Votre demande pour accèder au blog a été refusée pour cet email : ${e}</p>\n                            <p style="font-family: sans-serif; font-size: 14px; font-weight: normal; margin: 0; Margin-bottom: 15px;">Rôle demandé : ${requestedRole}</p>\n\n                            <table border="0" cellpadding="0" cellspacing="0" class="btn btn-primary" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; box-sizing: border-box;">\n                              <tbody>\n                                <tr>\n                                  <td align="left" style="font-family: sans-serif; font-size: 14px; vertical-align: top; padding-bottom: 15px;">\n                                    <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: auto;">\n                                      <tbody>\n                                        <tr>\n                                          <td style="font-family: sans-serif; font-size: 14px; vertical-align: top; background-color: #3498db; border-radius: 5px; text-align: center;"> <a href="${a}/#!" target="_blank" style="display: inline-block; color: #ffffff; background-color: #3498db; border: solid 1px #3498db; border-radius: 5px; box-sizing: border-box; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; margin: 0; padding: 12px 25px; text-transform: capitalize; border-color: #3498db;">Tant pis</a> </td>\n                                        </tr>\n\n                                      </tbody>\n                                    </table>\n                                  </td>\n                                </tr>\n                              </tbody>\n                            </table>\n\n                          </td>\n                        </tr>\n                      </table>\n                    </td>\n                  </tr>\n\n                \x3c!-- END MAIN CONTENT AREA --\x3e\n                </table>\n\n                \x3c!-- START FOOTER --\x3e\n                ${s.footer}\n                \x3c!-- END FOOTER --\x3e\n\n              \x3c!-- END CENTERED WHITE CONTAINER --\x3e\n              </div>\n            </td>\n            <td style="font-family: sans-serif; font-size: 14px; vertical-align: top;">&nbsp;</td>\n          </tr>\n        </table>\n      </body>\n    </html>`}}},function(e,t){const r={head:'<head>\n    <meta name="viewport" content="width=device-width">\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\n    <title>Simple Transactional Email</title>\n    <style>\n    /* -------------------------------------\n        RESPONSIVE AND MOBILE FRIENDLY STYLES\n    ------------------------------------- */\n    @media only screen and (max-width: 620px) {\n      table[class=body] h1 {\n        font-size: 28px !important;\n        margin-bottom: 10px !important;\n      }\n      table[class=body] p,\n            table[class=body] ul,\n            table[class=body] ol,\n            table[class=body] td,\n            table[class=body] span,\n            table[class=body] a {\n        font-size: 16px !important;\n      }\n      table[class=body] .wrapper,\n            table[class=body] .article {\n        padding: 10px !important;\n      }\n      table[class=body] .content {\n        padding: 0 !important;\n      }\n      table[class=body] .container {\n        padding: 0 !important;\n        width: 100% !important;\n      }\n      table[class=body] .main {\n        border-left-width: 0 !important;\n        border-radius: 0 !important;\n        border-right-width: 0 !important;\n      }\n      table[class=body] .btn table {\n        width: 100% !important;\n      }\n      table[class=body] .btn a {\n        width: 100% !important;\n      }\n      table[class=body] .img-responsive {\n        height: auto !important;\n        max-width: 100% !important;\n        width: auto !important;\n      }\n    }\n    /* -------------------------------------\n        PRESERVE THESE STYLES IN THE HEAD\n    ------------------------------------- */\n    @media all {\n      .ExternalClass {\n        width: 100%;\n      }\n      .ExternalClass,\n            .ExternalClass p,\n            .ExternalClass span,\n            .ExternalClass font,\n            .ExternalClass td,\n            .ExternalClass div {\n        line-height: 100%;\n      }\n      .apple-link a {\n        color: inherit !important;\n        font-family: inherit !important;\n        font-size: inherit !important;\n        font-weight: inherit !important;\n        line-height: inherit !important;\n        text-decoration: none !important;\n      }\n      .btn-primary table td:hover {\n        background-color: #34495e !important;\n      }\n      .btn-primary a:hover {\n        background-color: #34495e !important;\n        border-color: #34495e !important;\n      }\n    }\n    </style>\n  </head>',footer:'<div class="footer" style="clear: both; Margin-top: 10px; text-align: center; width: 100%;">\n              <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;">\n                <tr>\n                  <td class="content-block" style="font-family: sans-serif; vertical-align: top; padding-bottom: 10px; padding-top: 10px; font-size: 12px; color: #999999; text-align: center;">\n                    <span class="apple-link" style="color: #999999; font-size: 12px; text-align: center;">Cet email est généré automatiquement</span>\n                    <br><a href="http://i.imgur.com/CScmqnj.gif" style="text-decoration: underline; color: #999999; font-size: 12px; text-align: center;"></a>.\n                  </td>\n                </tr>\n                <tr>\n                  <td class="content-block powered-by" style="font-family: sans-serif; vertical-align: top; padding-bottom: 10px; padding-top: 10px; font-size: 12px; color: #999999; text-align: center;">\n                    <a href="" style="color: #999999; font-size: 12px; text-align: center; text-decoration: none;"></a>.\n                  </td>\n                </tr>\n              </table>\n            </div>'};e.exports=r},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("bcrypt")},function(e,t,r){e.exports=function(e,t,r,a){console.log("ERROR MIDDLEWARE",e,e.type);let s={};const i=!!s.fatal;let n={type:s.type||"ServerError",status:s.status||500,message:s.message||"Something went really wrong dude",error:s};switch(s.type){case"DatabaseError":n={status:s.status||500,message:s.message||"The data could not be saved / removed correctly from the database",error:s};break;case"ValidationError":n={status:s.status||403,message:s.message||"Ops! It seems that you don't pass valid data",error:s};case"AuthorizationError":n={status:s.status||403,message:s.message||"It seems that you don't have the permission to do what you do! Be careful man!",error:s}}i?console.log("FATAL ERROR"):(r.status(n.status),r.json(n),a())}},function(e,t,r){const a=r(0).Router(),s=r(25),i=r(6),n=r(7),o=r(2);a.route("/").get((e,t,r)=>{s.getAll(!1,e=>{o(t,r,e)})}).post((e,t,r)=>{i(e.body,"article","create").then(a=>{s.postArticle(e.body,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}).delete((e,t,r)=>{n(e.headers["x-access-token"],"superadmin").then(e=>{s.deleteAll(e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getArticle(!1,e.params.id,e=>{o(t,r,e)})}).put((e,t,r)=>{s.updateArticle(!1,e.body,e.params.id,e=>{o(t,r,e)})}).delete((e,t,r)=>{s.deleteArticle(e.params.id,e=>{o(t,r,e)})}),a.route("/published").get((e,t,r)=>{s.getAll(!0,e=>{o(t,r,e)})}),a.route("/published/:id([0-9]+)").get((e,t)=>{s.getArticle(!0,e.params.article,e=>{t.json(e)})}).post((e,t,r)=>{i(e.body.article,"article","publish").then(r=>{s.publishArticle(e.body,e.params.id,e=>{t.json(e)})}).catch(e=>{o(t,r,{type:"ValidationError",error:e})})}).put((e,t)=>{s.updateArticle(!0,e.body,e.params.id,e=>{t.json(e)})}).delete((e,t)=>{s.unpublishArticle(e.params.id,e=>{t.send(e)})}),e.exports=a},function(e,t,r){const a=r(1),s=r(4);e.exports=class{static getAll(e,t){let r=e?"published_articles":"articles";a.query("SELECT article_id, article_title_fr, article_title_it, article_slug_fr, article_slug_it, article_published_fr, article_published_it, article_published_date_fr, article_published_date_it, article_place_fr, article_place_it, article_travel_id, article_country_fr, article_country_it FROM "+r,(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}static getArticle(e,t,r){let s=e?"published_articles":"articles";a.query(`SELECT * FROM ${s} WHERE article_id = ?`,[t],(e,t)=>{if(e)r({type:"DatabaseError",error:e});else{var a=JSON.stringify(t),s=JSON.parse(a);r(s)}})}static postArticle(e,t){a.query("INSERT INTO `articles` SET ?",e,(e,r)=>{e?t({type:"DatabaseError",error:e}):a.query("SELECT * FROM `articles` WHERE article_id = ?",[r.insertId],(e,r)=>{t(r)})})}static updateArticle(e,t,r,s){t.article_id&&delete t.article_id,e?a.query("UPDATE articles SET ? WHERE article_id = ?",[t,r],(e,i)=>{e?s({type:"DatabaseError",error:e,message:"Could not update the travel"}):a.query("SELECT * FROM published_articles WHERE article_id = ?",r,(e,i)=>{e?s({type:"DatabaseError",error:e}):i.length?a.query("UPDATE published_articles SET ? WHERE article_id = ?",[t,r],(e,t)=>{e?s({type:"DatabaseError",error:e,message:"Could not update in published_article"}):a.query("SELECT * FROM `articles` WHERE article_id = ?",[r],(e,t)=>{s(t)})}):a.query("INSERT INTO published_articles SET ?",t,(e,t)=>{e?s({type:"DatabaseError",error:e}):a.query("SELECT * FROM `articles` WHERE article_id = ?",[r],(e,t)=>{s(t)})})})}):a.query("UPDATE articles SET ? WHERE article_id = ?",[t,r],(e,t)=>{e?s({type:"DatabaseError",error:e}):a.query("SELECT * FROM `articles` WHERE article_id = ?",[r],(e,t)=>{s(t)})})}static publishArticle(e,t,r){a.query("SELECT * FROM `published_articles` WHERE `article_id` = ?",t,(s,i)=>{s?r({type:"DatabaseError",error:s}):i.length?a.query("UPDATE `published_articles` SET ? WHERE `article_id` = ?",[e,t],(e,t)=>{r(e?{type:"DatabaseError",error:e}:t)}):a.query("INSERT INTO `published_articles` SET ?",e,(e,t)=>{r(e?{type:"DatabaseError",error:e}:t)})})}static unpublishArticle(e,t){a.query("DELETE FROM `published_articles` WHERE `article_id` = ?",e,(r,a)=>{r?t({type:"DatabaseError",error:r}):1!==a.affectedRows?t({type:"ServerError",message:"There is no article with such id in DB"}):(t(a),s.postUnpublishEntity("article",e,e=>{console.log("Settings updated",e)}))})}static deleteArticle(e,t){var r={},s={};a.query("DELETE FROM `articles` WHERE `article_id` = ?",e,(e,a)=>{e&&t({type:"DatabaseError",error:e}),r=a}),a.query("SELECT * FROM `published_articles` WHERE `article_id` = ?",e,(r,a)=>{r?t({type:"DatabaseError",error:r}):a.length&&this.unpublishArticle(e,e=>{s=e})});const i=Object.assign({},r,s);t(i)}static deleteAll(e){let t={},r={};a.query("DELETE * FROM `articles`",(r,a)=>{r?e({type:"DatabaseError",error:r}):t=a}),a.query("DELETE * FROM `published_articles`",(t,a)=>{t?e({type:"DatabaseError",error:t}):r=a});const s=Object.assign({},t,r);e(s)}}},function(e,t,r){const a=r(3),s=a.object({email:a.string().email().required(),role:a.string().required().valid("visitor","editor","admin")}),i=a.object({email:a.string().email().required(),password:a.string().required()}),n=a.object({email:a.string().email().required(),password:a.string().required()}),o=a.object({email:a.string().email().required(),token:a.string().required()}),l=a.object({token:a.string().required()}),c={create:s,signup:i,signin:n,request:a.object({type:a.string().required(),email:a.string().email().required(),role:a.string().required().valid("admin","visitor","editor"),pwd_token:a.any()}),token:l,reset:o};e.exports=c},function(e,t,r){const a=r(3),s={create:a.alternatives().try(a.object().keys({article_title_fr:a.string().allow(""),article_title_it:a.string(),article_travel_id:a.number(),article_country_fr:a.string().allow(""),article_country_it:a.string().allow(""),article_place_fr:a.string().allow(""),article_place_it:a.string().allow(""),article_catch_phrase_fr:a.string().allow(""),article_catch_phrase_it:a.string().allow(""),article_short_desc_fr:a.string().allow(""),article_short_desc_it:a.string().allow(""),article_long_desc_fr:a.string().allow(""),article_long_desc_it:a.string().allow(""),article_gallery_fr:a.string().allow(""),article_gallery_it:a.string().allow(""),article_start_date:a.number(),article_end_date:a.number(),article_published_date_fr:a.any(),article_published_date_it:a.any(),article_published_fr:a.any(),article_published_it:a.any(),article_slug_fr:a.string().allow(""),article_slug_it:a.string().allow(""),article_size_fr:a.string().allow(""),article_size_it:a.string().allow(""),article_cover_fr:a.number().allow(null),article_cover_it:a.number().allow(null),article_cover_mobile_fr:a.number().allow(null),article_cover_mobile_it:a.number().allow(null)}),a.object().keys({article_title_fr:a.string().allow(""),article_title_it:a.string().allow(""),article_travel_id:a.number(),article_country_fr:a.string().allow(""),article_country_it:a.string().allow(""),article_place_fr:a.string().allow(""),article_place_it:a.string().allow(""),article_catch_phrase_fr:a.string().allow(""),article_catch_phrase_it:a.string().allow(""),article_short_desc_fr:a.string().allow(""),article_short_desc_it:a.string().allow(""),article_long_desc_fr:a.string().allow(""),article_long_desc_it:a.string().allow(""),article_gallery_fr:a.string().allow(""),article_gallery_it:a.string().allow(""),article_start_date:a.number(),article_end_date:a.number(),article_published_date_fr:a.any(),article_published_date_it:a.any(),article_published_fr:a.any(),article_published_it:a.any(),article_slug_fr:a.string().allow(""),article_slug_it:a.string().allow(""),article_size_fr:a.string().allow(""),article_size_it:a.string().allow(""),article_cover_fr:a.number().allow(null),article_cover_it:a.number().allow(null),article_cover_mobile_fr:a.number().allow(null),article_cover_mobile_it:a.number().allow(null)})),publish:a.alternatives().try(a.object().keys({article_id:a.number().required(),article_title_fr:a.string().allow(""),article_title_it:a.string().allow(""),article_travel_id:a.number().required(),article_country_fr:a.string().allow(""),article_country_it:a.string().allow(""),article_place_fr:a.string().allow(""),article_place_it:a.string().allow(""),article_slug_fr:a.string().allow(""),article_slug_it:a.string().allow(""),article_size_fr:a.string().allow(""),article_size_it:a.string().allow(""),article_catch_phrase_fr:a.string().allow(""),article_catch_phrase_it:a.string().allow(""),article_short_desc_fr:a.string().allow(""),article_short_desc_it:a.string().allow(""),article_long_desc_fr:a.string().allow(""),article_long_desc_it:a.string().allow(""),article_gallery_fr:a.string().allow(""),article_gallery_it:a.string().allow(""),article_cover_fr:a.number().allow(null),article_cover_it:a.number().allow(null),article_cover_mobile_fr:a.number().allow(null),article_cover_mobile_it:a.number().allow(null),article_start_date:a.number(),article_end_date:a.number(),article_published_fr:a.any(),article_published_it:a.any(),article_published_date_fr:a.any(),article_published_date_it:a.any()}),a.object().keys({article_id:a.number().required(),article_title_fr:a.string().allow(""),article_title_it:a.string().allow(""),article_travel_id:a.number().required(),article_country_fr:a.string().allow(""),article_country_it:a.string().allow(""),article_place_fr:a.string().allow(""),article_place_it:a.string().allow(""),article_slug_fr:a.string().allow(""),article_slug_it:a.string().allow(""),article_size_fr:a.string().allow(""),article_size_it:a.string().allow(""),article_catch_phrase_fr:a.string().allow(""),article_catch_phrase_it:a.string().allow(""),article_short_desc_fr:a.string().allow(""),article_short_desc_it:a.string().allow(""),article_long_desc_fr:a.string().allow(""),article_long_desc_it:a.string().allow(""),article_gallery_fr:a.string().allow(""),article_gallery_it:a.string().allow(""),article_cover_fr:a.number().allow(null),article_cover_it:a.number().allow(null),article_cover_mobile_fr:a.number().allow(null),article_cover_mobile_it:a.number().allow(null),article_start_date:a.number(),article_end_date:a.number(),article_published_fr:a.any(),article_published_it:a.any(),article_published_date_fr:a.any(),article_published_date_it:a.any()}))};e.exports=s},function(e,t,r){const a=r(3),s={create:a.object({email:a.string().email().required(),role:a.string().required().valid("visitor","editor","admin")})};e.exports=s},function(e,t,r){const a=r(3),s={create:a.object({email:a.string().email().required(),role:a.string().required().valid("visitor","editor","admin")})};e.exports=s},function(e,t,r){const a=r(0).Router(),s=r(31),i=r(2);a.route("/").get((e,t)=>{s.getAll(!1,e=>{t.json(e)})}).post((e,t,r)=>{s.addTravel(!1,e.body,e=>{i(t,r,e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getTravel(!1,e.params.id,e=>{t.json(e)})}).put((e,t,r)=>{s.updateTravel(!1,e.body,e.params.id,e=>{i(t,r,e)})}).delete((e,t,r)=>{s.deleteTravel(e.params.id,e=>{i(t,r,e)})}),a.route("/:id([0-9]+)/articles").get((e,t)=>{s.getAllArticlesByTravel(e.params.id,e=>{t.json(e)})}),a.route("/published").get((e,t)=>{s.getAll(!0,e=>{t.json(e)})}),a.route("/published/:id([0-9]+)").get((e,t)=>{s.getTravel(!0,e.params.travel,e=>{t.json(e)})}).post((e,t,r)=>{s.addTravel(!0,e.body,e=>{i(t,r,e)})}).put((e,t,r)=>{s.updateTravel(!0,e.body,e.params.id,e=>{i(t,r,e)})}).delete((e,t,r)=>{s.unpublishTravel(e.params.id,e=>{i(t,r,e)})}),e.exports=a},function(e,t,r){const a=r(1),s=r(4);e.exports=class{static getAll(e,t){let r=e?"published_travels":"travels";a.query("SELECT travel_id, travel_title_fr, travel_title_it, travel_published_fr, travel_published_it, travel_published_date_fr, travel_published_date_it, travel_desc_fr, travel_desc_it, travel_countries_fr, travel_countries_it, travel_start_date, travel_end_date, travel_slug_fr, travel_slug_it, travel_category, travel_same_start_end FROM "+r,(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}static getTravel(e,t,r){let s=e?"published_travels":"travels";a.query(`SELECT * FROM ${s} WHERE travel_id = ?`,[t],(e,t)=>{if(e)r({type:"DatabaseError",error:e});else{var a=JSON.stringify(t),s=JSON.parse(a);r(s)}})}static addTravel(e,t,r){e?a.query("SELECT * FROM published_travels WHERE travel_id = ?",t.travel_id,(e,s)=>{e?r({type:"DatabaseError",error:e}):(console.log(s),s.length?a.query("UPDATE `published_travels` SET ? WHERE travel_id = ?",[t,t.travel_id],(e,t)=>{r(e?{type:"DatabaseError",error:e}:t)}):a.query("INSERT INTO `published_travels` SET ?",t,(e,t,s)=>{e?r({type:"DatabaseError",error:e}):a.query("SELECT * FROM `published_travels` WHERE travel_published_id = ?",[t.insertId],(e,t)=>{r(t)})}))}):a.query("INSERT INTO travels SET ?",t,(e,t,s)=>{e?r({type:"DatabaseError",error:e}):a.query("SELECT * FROM `travels` WHERE travel_id = ?",[t.insertId],(e,t)=>{r(t)})})}static updateTravel(e,t,r,s){e?a.query("UPDATE travels SET ? WHERE travel_id = ?",[t,r],(e,i)=>{e?s({type:"DatabaseError",error:e}):a.query("SELECT * FROM published_travels WHERE travel_id = ?",r,(e,i)=>{e?s({type:"DatabaseError",error:e}):i.length?a.query("UPDATE published_travels SET ? WHERE travel_id = ?",[t,r],(e,t)=>{s(e?{type:"DatabaseError",error:e}:t)}):a.query("INSERT INTO published_travels SET ?",t,(e,t,r)=>{s(e?{type:"DatabaseError",error:e}:t)})})}):a.query("UPDATE travels SET ? WHERE travel_id = ?",[t,r],(e,t)=>{s(e?{type:"DatabaseError",error:e}:t)})}static unpublishTravel(e,t){a.query("DELETE FROM published_travels WHERE travel_id = ?",e,(r,a)=>{r?t({type:"DatabaseError",error:r}):1!==a.affectedRows?t({type:"ServerError",message:"There is no travel with such id in DB"}):(t(a),s.postUnpublishEntity("travel",e,e=>{console.log("Settings updated",e)}))})}static deleteTravel(e,t){var r={},s={};a.query("DELETE FROM `travels` WHERE `travel_id` = ?",e,(e,a)=>{e&&t({type:"DatabaseError",error:e}),r=a}),a.query("SELECT * FROM `published_travels` WHERE `travel_id` = ?",e,(r,a)=>{r?t({type:"DatabaseError",error:r}):a.length&&this.unpublishTravel(e,e=>{s=e})}),a.query("DELETE FROM `articles` WHERE `article_travel_id` = ?",e,(e,r)=>{e&&t({type:"DatabaseError",error:e})}),a.query("DELETE FROM `published_articles` WHERE `article_travel_id` = ?",e,(e,r)=>{e&&t({type:"DatabaseError",error:e})});const i=Object.assign({},r,s);t(i)}static getAllArticlesByTravel(e,t){a.query("SELECT * FROM articles WHERE article_travel_id = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}}},function(e,t,r){const a=r(0).Router(),s=r(5),i=r(6),n=r(7),o=r(2);a.route("/").get((e,t,r)=>{s.getUsers(e=>{o(t,r,e)})}).post((e,t,r)=>{i(e.body.user,"user","create").then(a=>{s.createNewUser(e.body.user,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getUserById(e.params.id,e=>{o(t,r,e)})}).put((e,t)=>{}).delete((e,t,r)=>{n(e.headers["x-access-token"],["admin","superadmin"]).then(()=>{s.deleteUser(e.params.id,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/email/:email").get((e,t,r)=>{s.getUserByEmail(e.params.email,e=>{o(t,r,e)})}),a.route("/request").post((e,t,r)=>{i(e.body,"user","request").then(a=>{"request"!==e.body.type?n(e.headers["x-access-token"],"superadmin").then(()=>{s.userRequest(e.body.type,e.body.email,e.body.role,e.body.pwd_token,e=>{o(t,r,e)})}).catch(e=>{t.json(e)}):s.userRequest(e.body.type,e.body.email,e.body.role,e.body.pwd_token,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/verifytoken").post((e,t,r)=>{i(e.body,"user","token").then(a=>{s.verifyToken(e.body.token,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/signin").post((e,t,r)=>{i(e.body,"user","signin").then(a=>{s.signin(e.body.email,e.body.password,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/signup").post((e,t,r)=>{i(e.body,"user","signup").then(a=>{s.signup(e.body.email,e.body.password,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/reset-password").post((e,t,r)=>{i(e.body,"user","reset").then(a=>{s.resetPasswordRequest(e.body.email,e.body.token,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),a.route("/confirm-reset-password").post((e,t,r)=>{i(e.body,"user","signup").then(a=>{s.signup(e.body.email,e.body.password,e=>{o(t,r,e)})}).catch(e=>{t.json(e)})}),e.exports=a},function(e,t,r){const a=r(0).Router(),s=r(34),i=r(35),n=r(2);a.route("/").get((e,t,r)=>{s.getAll(e=>{n(t,r,e)})}).post(i.any("file"),(e,t,r)=>{s.uploadAssets(e.files,e.body.infos,e=>{n(t,r,e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getAsset(e.params.id,e=>{n(t,r,e)})}).put((e,t,r)=>{s.updateAsset(e.body,e.params.id,e=>{n(t,r,e)})}),a.route("/delete").post((e,t,r)=>{s.deleteAssets(e.body.ids,e.body.names,e=>{n(t,r,e)})}),e.exports=a},function(e,t,r){const a=r(8),s=r(1);e.exports=class{static getAll(e){s.query("SELECT * FROM assets",(t,r)=>{if(t)e({type:"DatabaseError",error:t});else{var a=JSON.stringify(r),s=JSON.parse(a);e(s)}})}static getAllByCountry(e,t){s.query("SELECT * FROM articles WHERE article_country = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}static getAsset(e,t){s.query("SELECT * FROM assets WHERE asset_id = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{var a=JSON.stringify(r),s=JSON.parse(a);t(s)}})}static uploadAssets(e,t,r){var a=[];try{for(var i=0;i<e.length;i++){const o=e[i].transforms.find(e=>"original"===e.id),l=o?o.key.split("/")[1].toLowerCase():e[i].originalname.toLowerCase(),c=o.location;var n={asset_title_fr:t[i].title_fr,asset_title_it:t[i].title_it,asset_travel_id:t[i].travel_id,asset_name:l,asset_src:c,asset_cover:0,asset_place_it:t[i].place_it,asset_place_fr:t[i].place_fr,asset_country_it:t[i].country_it,asset_country_fr:t[i].country_fr,asset_desc_it:t[i].desc_it,asset_desc_fr:t[i].desc_fr,asset_type:e[i].mimetype,asset_article_ids:e[i].article_ids||JSON.stringify([])};s.query("INSERT INTO assets SET ?",n,(e,t)=>{e?r({type:"DatabaseError",error:e,message:"The asset is available in full size on AWS but not registered in database"}):(console.log(a),a.push(t))})}r(a)}catch(e){r({type:"DatabaseError",error:e})}}static updateAsset(e,t,r){s.query("UPDATE assets SET ? WHERE asset_id = ?",[e,t],(function(e,t){r(e?{type:"DatabaseError",error:e}:t)}))}static deleteAssets(e,t,r){console.info(e,t);try{for(var i=[],n=0;n<e.length;n++){var o=e[n];t[n];s.query("DELETE FROM assets WHERE asset_id = ?",o,(e,t)=>{e?r({type:"DatabaseError",error:e}):i.push(t)})}r(i);const l=new a.S3;l.listObjects({Bucket:process.env.S3_BUCKET_NAME},(e,r)=>{if(!e&&r){const e=[];r.Contents.forEach((r,a)=>{t.forEach((t,a)=>{r.Key.includes(t)&&e.push({Key:r.Key})})});const a={Bucket:process.env.S3_BUCKET_NAME,Delete:{Objects:e,Quiet:!1}};l.deleteObjects(a,(e,t)=>{e?console.log(e):console.log(t)})}})}catch(e){r({type:"DatabaseError",error:e})}}}},function(e,t,r){const a=r(36);const s=r(37),i=r(38),n=r(39);n.cache({files:0});const o=a({storage:i({s3:new s.S3,bucket:process.env.S3_BUCKET_NAME,acl:"public-read",contentType:i.AUTO_CONTENT_TYPE,shouldTransform:function(e,t,r){r(null,/^image/i.test(t.mimetype))},transforms:[{id:"original",key:function(e,t,r){e.timestamp=(new Date).getTime();const a=t.originalname.toLowerCase();r(null,`img/${e.timestamp}_${a}`)},transform:function(e,t,r){r(null,n().resize(1e3).jpeg())}},{id:"thumbnail",key:function(e,t,r){const a=t.originalname.toLowerCase();r(null,`thumb/mini_${e.timestamp}_${a}`)},transform:function(e,t,r){r(null,n().resize(400).jpeg())}}]})});e.exports=o},function(e,t){e.exports=require("multer")},function(e,t,r){const a=r(8);a.config.update({secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY,accessKeyId:process.env.AWS_ACCESS_KEY_ID}),e.exports=a},function(e,t){e.exports=require("multer-s3-transform")},function(e,t){e.exports=require("sharp")},function(e,t,r){const a=r(0).Router(),s=r(41),i=r(2);a.route("/").get((e,t,r)=>{s.getAll(e=>{i(t,r,e)})}).post((e,t,r)=>{s.saveAnecdote(e.body,e=>{i(t,r,e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getAnecdote(e.params.id,e=>{i(t,r,e)})}).put((e,t,r)=>{s.updateAnecdote(e.body,e.params.id,e=>{i(t,r,e)})}).delete((e,t,r)=>{s.removeAnecdote(e.params.id,e=>{i(t,r,e)})}),e.exports=a},function(e,t,r){const a=r(1);e.exports=class{static getAll(e){a.query("SELECT anecdote_id, anecdote_title, anecdote_content FROM anecdotes",(t,r)=>{if(t)e({type:"DatabaseError",error:t});else{const t=JSON.parse(JSON.stringify(r));e(t)}})}static getAnecdote(e,t){a.query("SELECT * FROM anecdotes WHERE anecdote_id = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{const e=JSON.parse(JSON.stringify(r));t(e[0])}})}static saveAnecdote(e,t){a.query("INSERT INTO `anecdotes` SET ?",e,(e,r)=>{e?t({type:"DatabaseError",error:e}):a.query("SELECT * FROM `anecdotes` WHERE anecdote_id = ?",[r.insertId],(e,r)=>{t(r)})})}static updateAnecdote(e,t,r){a.query("UPDATE anecdotes SET ? WHERE anecdote_id = ?",[e,t],(e,t)=>{r(e?{type:"DatabaseError",error:e}:t)})}static removeAnecdote(e,t){a.query("DELETE FROM anecdotes WHERE anecdote_id = ?",[e],(e,r)=>{t(e?{type:"DatabaseError",error:e}:r)})}}},function(e,t,r){const a=r(0).Router(),s=r(43),i=r(2);a.route("/").get((e,t,r)=>{s.getAll(e=>{i(t,r,e)})}).post((e,t,r)=>{s.saveCategory(e.body,e=>{i(t,r,e)})}),a.route("/:id([0-9]+)").get((e,t,r)=>{s.getCategory(e.params.id,e=>{i(t,r,e)})}).put((e,t,r)=>{s.updateCategory(e.body,e.params.id,e=>{i(t,r,e)})}).delete((e,t,r)=>{s.removeCategory(e.params.id,e=>{i(t,r,e)})}),e.exports=a},function(e,t,r){const a=r(1);e.exports=class{static getAll(e){a.query("SELECT * FROM categories",(t,r)=>{if(t)e({type:"DatabaseError",error:t});else{const t=JSON.parse(JSON.stringify(r));e(t)}})}static getCategory(e,t){a.query("SELECT * FROM categories WHERE category_id = ?",[e],(e,r)=>{if(e)t({type:"DatabaseError",error:e});else{const e=JSON.parse(JSON.stringify(r));t(e[0])}})}static saveCategory(e,t){a.query("INSERT INTO categories SET ?",e,(e,r)=>{e?t({type:"DatabaseError",error:e}):a.query("SELECT * FROM `categories` WHERE category_id = ?",[results.insertId],(e,r)=>{t(r)})})}static updateCategory(e,t,r){a.query("UPDATE categories SET ? WHERE category_id = ?",[e,t],(e,s)=>{e?r({type:"DatabaseError",error:e}):a.query("SELECT * FROM `categories` WHERE category_id = ?",[t],(e,t)=>{r(t)})})}static removeCategory(e,t){a.query("DELETE FROM categories WHERE category_id = ?",[e],(e,r)=>{t(e?{type:"DatabaseError",error:e}:r)})}}},function(e,t,r){const a=r(0).Router(),s=r(4),i=r(2);a.route("/").get((e,t)=>{s.getSettings(e=>{t.json(e[0])})}).put((e,t,r)=>{s.updateSettings(e.body,e=>{i(t,r,e)})}),e.exports=a}]);